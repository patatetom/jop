<!DOCTYPE html>
<html lang="en" dir="ltr">
<!--
head --------------------------------------------------------------------------
-->
<head>
<title>JOP***_</title>
<meta charset="utf-8" />
<meta name="description" content="Password generator" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Patatetom (b9065a2c6fe4a957980e230cdd1ac9b349ce4660)" />
<meta name="publisher" content="https://github.com/patatetom/jop" />
<!--
style -------------------------------------------------------------------------
-->
<style type="text/css">
.container {
	font-family: arial;
	background-color: cornflowerBlue;
	max-width: 14rem;
	margin: auto;
	padding: 1rem;
	border-radius: 1rem;
}
h1 {
	color: white;
	font-size: 2.5rem;
	margin: 0.5rem;
	-webkit-user-select: none;
	user-select: none;
}
h1 span {
	animation: blinker 1s linear infinite;
}
@keyframes blinker {
	50% {
		opacity: 0;
	}
}
img {
	vertical-align: middle;
	width: 1rem;
	filter: invert(1);
}
input {
	margin: 0.25rem;
}
input[type="text"]:invalid {
	background-color: lightPink;
}
@supports (-webkit-text-security: square) {
	#secret {
		-webkit-text-security: square;
	}
	#secret::placeholder {
		-webkit-text-security: none;
	}
}
@supports not (-webkit-text-security: square) {
	#secret {
		text-decoration-line: line-through;
		text-decoration-style: double;
		text-decoration-thickness: 0.5rem;
	}
	#secret::placeholder {
		text-decoration-line: none;
	}
}
#password {
	color: aliceBlue;
	background-color: cornflowerBlue;
}
</style>
</head>
<!--
body --------------------------------------------------------------------------
-->
<body>
<div class="container">
	<h1>JOP***<span title="Just One Password">_</span></h1>
	<form id="jop" autocomplete="off">
	<table><tr><td>
		<input id="service" required type="text" minlength="2" placeholder="Service" list="services" autofocus />
	</td>	<td>
		<img id="send" title="Export service list" src="data:image/svg+xml;base64,	
PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItc2VuZCI+PGxpbmUgeDE9IjIyIiB5MT0iMiIgeDI9IjExIiB5Mj0iMTMiPjwvbGluZT48cG9seWdvbiBwb2ludHM9IjIyIDIgMTUgMjIgMTEgMTMgMiA5IDIyIDIiPjwvcG9seWdvbj48L3N2Zz4=" />
	</td></tr><tr><td>
		<input id="secret" required type="text" minlength="3" placeholder="Secret" />
	</td><td>
		<img id="show" title="Show/hide secret" src="data:image/svg+xml;base64,
PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItaW5zdGFncmFtIj48cmVjdCB4PSIyIiB5PSIyIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHJ4PSI1IiByeT0iNSI+PC9yZWN0PjxwYXRoIGQ9Ik0xNiAxMS4zN0E0IDQgMCAxIDEgMTIuNjMgOCA0IDQgMCAwIDEgMTYgMTEuMzd6Ij48L3BhdGg+PGxpbmUgeDE9IjE3LjUiIHkxPSI2LjUiIHgyPSIxNy41MSIgeTI9IjYuNSI+PC9saW5lPjwvc3ZnPg==" />
	</td></tr><tr><td>
		<input id="generate" type="submit" value="Generate »" />
	</td><td>
		<img id="clear" title="Clear form" src="data:image/svg+xml;base64,	
PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXIteC1jaXJjbGUiPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48bGluZSB4MT0iMTUiIHkxPSI5IiB4Mj0iOSIgeTI9IjE1Ij48L2xpbmU+PGxpbmUgeDE9IjkiIHkxPSI5IiB4Mj0iMTUiIHkyPSIxNSI+PC9saW5lPjwvc3ZnPg==" />
	</td></tr><tr><td>
		<input id="password" type="text" placeholder="Password" readonly="true" />
	</td><td>
		<img id="copy" title="Copy password to clipboard" src="data:image/svg+xml;base64,
PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItcGFwZXJjbGlwIj48cGF0aCBkPSJNMjEuNDQgMTEuMDVsLTkuMTkgOS4xOWE2IDYgMCAwIDEtOC40OS04LjQ5bDkuMTktOS4xOWE0IDQgMCAwIDEgNS42NiA1LjY2bC05LjIgOS4xOWEyIDIgMCAwIDEtMi44My0yLjgzbDguNDktOC40OCI+PC9wYXRoPjwvc3ZnPg==" />
	</td></tr></table>
	</form>
</div>
<datalist id="services"></datalist>
<!--
script ------------------------------------------------------------------------
-->
<script>
// language -------------------------------------------------------------------
// (use fr function as template to create a new language)
var reset = "WARNING: Delete service list ?";
if (navigator.language) {
	const language = navigator.language.split("-")[0];
	if (language && language !== "en") {
		try {
			window[language]();
		} catch {
			true;
		};
	};
};
function fr() { // french
	document.documentElement.lang = "fr";
	document.head.querySelector('meta[name="description"]').content = "Générateur de mot de passe";
	send.title = "Exporter la liste des services";
	show.title = "Afficher/masquer le secret";
	clear.title = "Nettoyer le formulaire";
	copy.title = "Copier le mot de passe vers le presse-papiers";
	generate.value = "Générer »";
	password.placeholder = "Mot de passe";
	reset = "ATTENTION: Effacer la liste des services ?";
};
// import/reset services ------------------------------------------------------
const url = new URL(location);
if (url.search) {
	if (url.search === "?resetServices") {
		if (confirm(reset)) {
			try {
				localStorage.removeItem("services");
			} catch {
				true;
			};
		};
		location.replace(url.origin.replace(/^null$/, "") + url.pathname);
	} else {
		let providers = url.searchParams.get("services");
		if (providers) {
			try {
				providers = JSON.parse(providers);
			} catch {
				providers = [];
			};
			providers = [...new Set(getProviders().concat(providers))];
			localStorage.setItem("services", JSON.stringify(providers));
		};
		location.replace(url.origin.replace(/^null$/, "") + url.pathname);
	};
};
// services -------------------------------------------------------------------
service.pattern = "^(\\+|-)?[1-9]? +[^\"']{3,}|^[^1-9 \"'+\\-][^\"']{2,}";
function getProviders() {
	let providers;
	try {
		providers = JSON.parse(window.localStorage.getItem("services") || "[]");
	} catch {
		providers = [];
	};
	return providers;
};
getProviders().forEach(
	service => services.innerHTML += ('<option value="' + service + '"/>')
);
// events ---------------------------------------------------------------------
var secretTimer;
var displayTimer;
const okImage = "data:image/svg+xml;base64,\
PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2hlY2stY2lyY2xlIj48cGF0aCBkPSJNMjIgMTEuMDhWMTJhMTAgMTAgMCAxIDEtNS45My05LjE0Ij48L3BhdGg+PHBvbHlsaW5lIHBvaW50cz0iMjIgNCAxMiAxNC4wMSA5IDExLjAxIj48L3BvbHlsaW5lPjwvc3ZnPg==";
function okNotify(image, event, listener) {
	image.removeEventListener(event, listener);
	let src = image.src;
	image.src = okImage;
	setTimeout(function() {
		image.src = src;
		image.addEventListener(event, listener);
	}, 1000);
}
function hideSecret() {
	if (CSS.supports("-webkit-text-security", "square")) {
		secret.style.WebkitTextSecurity = "square";
	} else {
		secret.style.textDecorationLine = "line-through";
	};
};
function restartSecretTimer() {
	clearTimeout(secretTimer);
	if (secret.value) {
		secretTimer = setTimeout(function(){
			secret.value = "";
			secret.style.textDecorationLine = "none";
		}, 30000);
	};
};
service.addEventListener("input", function() {
	password.value = "";
	restartSecretTimer();
	clearTimeout(displayTimer);
});
secret.addEventListener("input", function() {
	password.value = "";
	restartSecretTimer();
	clearTimeout(displayTimer);
});
send.addEventListener("click", exportServices);
async function exportServices() {
	let providers = getProviders();
	if (providers.length) {
		okNotify(send, "click", exportServices);
		const search = "?services=" + JSON.stringify(providers);
		try {
			await navigator.clipboard.writeText(search);
		} catch {
			let dummy = document.createElement("input");
			dummy.value = search; dummy.select();
			document.execCommand("copy");
		};
	};
	service.focus();
};
clear.addEventListener("click", function() {
	password.value = "";
	secret.value = "";
	service.value = "";
	clearTimeout(secretTimer);
	clearTimeout(displayTimer);
	service.focus();
});
show.addEventListener("click", function() {
	if (secret.value) {
		if (CSS.supports("-webkit-text-security", "square")) {
			secret.style.WebkitTextSecurity = secret.style.WebkitTextSecurity == "unset" ? "square" : "unset";
		} else {
			secret.style.textDecorationLine = secret.style.textDecorationLine == "none" ? "line-through" : "none";
		};
		setTimeout(hideSecret, 5000);
	};
	restartSecretTimer();
	secret.focus();
});
copy.addEventListener("click", copyPassword);
async function copyPassword() {
	if (password.value) {
		okNotify(copy, "click", copyPassword);
		try {
			await navigator.clipboard.writeText(password.value);
		} catch {
			password.select();
			document.execCommand("copy");
		};
		clear.click();
	};
};
jop.addEventListener("submit", generatePassword);
function generatePassword(event) {
	event.preventDefault();
	restartSecretTimer();
	service.value = service.value.trim();
	secret.value = secret.value.trim();
	if (!service.value || service.validity.tooShort || service.validity.patternMismatch) {
		service.focus();
	} else if (!secret.value || secret.validity.tooShort) {
		secret.focus();
	} else {
		hideSecret();
		let salt = service.value.trim();
		const master = secret.value.trim();
		let rank = "1";
		let symbol = true;
		const flag = salt.match(/^(\+|-)?([1-9]?) +(.{3,})/);
		if (flag) {
			salt = flag.at(-1).trim();
			rank = flag.at(-2) || "1";
			symbol = flag.at(-3) !== "-" ? true : false;
		};
		generatePasswordFromPBKDF2(master, (salt + "#" + rank), symbol);
		clearTimeout(displayTimer);
		displayTimer = setTimeout(function(){
			secret.value = "";
			password.value = "";
			secret.style.textDecorationLine = "none";
		}, 30000);
		let providers = getProviders();
		if (!providers.includes(service.value)) {
			providers.push(service.value);
			services.innerHTML += ('<option value="' + service.value + '"/>');
			try {
				window.localStorage.setItem("services", JSON.stringify(providers));
			} catch {
				true;
			};
		};
		service.focus();
	};
};
// pbkdf2 webcrypto browser ---------------------------------------------------
async function generatePasswordFromPBKDF2(master, salt, symbol) {
	const encode = new TextEncoder();
	const importedKey = await window.crypto.subtle.importKey("raw", encode.encode(master), "pbkdf2", false, ["deriveBits"]);
	const derivedBits = await window.crypto.subtle.deriveBits({name: "pbkdf2", salt: encode.encode(salt), iterations: 1e4, hash: "sha-256"}, importedKey, 256);
	const arrayDerivedBits = new Uint8Array(derivedBits, 0, 32);
	password.value = _render_password(toHex(arrayDerivedBits), 16, symbol);
};
const toHex = function(byteArray) {
	return Array.from(byteArray, byte => ('0' + (byte & 0xFF).toString(16)).slice(-2)).join('');
};
// lesspass from python -------------------------------------------------------
// https://github.com/lesspass/lesspass/blob/8.0.2/cli/lesspass/password.py
const lowercase = "abcdefghijklmnopqrstuvwxyz";
const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const digits = "0123456789";
const symbols = "(.,;:!?)[=+-*/&|]{#$%@_~}";
function _get_set_of_characters(symbol) {
	const characters = lowercase + digits + uppercase + (symbol && symbols || "");
	return characters;
};
function _consume_entropy(password, entropy, length, characters) {
	if (password.length >= length) return [password, entropy];
	const byte = parseInt(entropy.slice(-2), 16);
	return (
		entropy = entropy.slice(0, -1),
		password += characters[byte % characters.length],
		_consume_entropy(password, entropy, length, characters)
	);
};
function _insert_characters_pseudo_randomly(password, entropy, sample) {
	for (index in sample) {
		var byte = parseInt(entropy.slice(-2), 16);
		var length = byte % password.length;
		password = password.slice(0, length) + sample[index] + password.slice(length), entropy = entropy.slice(0, -1);
	};
	return password;
};
function _get_one_character_per_set(entropy, symbol) {
	var sample = "";
	var [character, entropy] = _consume_entropy("", entropy, 1, lowercase);
	return (
		sample += character,
		[character, entropy] = _consume_entropy("", entropy, 1, uppercase),
		sample += character,
		[character, entropy] = _consume_entropy("", entropy, 1, digits),
		sample += character,
		symbol && (
			[character, entropy] = _consume_entropy("", entropy, 1, symbols),
			sample += character
		),
		[sample, entropy]
	);
};
function _render_password(entropy, length, symbol) {
	const characters = _get_set_of_characters(symbol);
	length -= symbol ? 4 : 3;
	var [password, entropy] = _consume_entropy("", entropy, length, characters);
	var [sample, entropy] = _get_one_character_per_set(entropy, symbol);
	return _insert_characters_pseudo_randomly(password, entropy, sample);
};
</script>
</body>
</html>
